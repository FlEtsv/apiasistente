server:
  port: 8082
  error:
    include-message: always
    include-binding-errors: always
    include-stacktrace: always

spring:
  # ConfiguraciÃ³n de base de datos para persistir sesiones, documentos y embeddings.
  datasource:
    url: jdbc:mysql://${MYSQL_HOST:apiasistente_mysql}:${MYSQL_PORT:3306}/${MYSQL_DB:apiasistente_db}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    username: ${MYSQL_USER:apiuser}
    password: ${MYSQL_PASSWORD:apipassword}

  jpa:
    hibernate:
      # Mantiene el esquema actualizado para acelerar prototipos.
      ddl-auto: update
    properties:
      hibernate:
        format_sql: true
    # Evita que las vistas abran transacciones largas en web.
    open-in-view: false
    defer-datasource-initialization: true

  sql:
    init:
      mode: always
      # opcional: si quieres ser explÃ­cito
      # schema-locations: classpath:schema.sql
      # data-locations: classpath:data.sql

ollama:
  # Endpoint base del servidor Ollama (local o contenedor).
  base-url: ${OLLAMA_BASE_URL:http://192.168.1.61:11434/api}
  #base-url: ${OLLAMA_BASE_URL:http://ollama:11434/api}
  # Modelo para generaciÃ³n de chat.
  chat-model: llama3.1:8b
  # Modelo rÃ¡pido para chats ligeros (menor consumo).
  fast-chat-model: gemma2:9b
  # Modelo visual para etapa intermedia de imagen/camara/documento.
  visual-model: qwen2.5vl:7b
  # Mini-modelo opcional para depurar respuestas y quitar relleno.
  response-guard-model: ${OLLAMA_RESPONSE_GUARD_MODEL:mistral:7b}
  # Modelo para embeddings de RAG.
  embed-model: nomic-embed-text:latest

rag:
  # NÃºmero de chunks mÃ¡s relevantes a recuperar por consulta.
  top-k: 6
  # MÃ¡ximo de mensajes previos en el historial de contexto.
  max-history: 16
  retrieval:
    # Turnos previos del usuario para enriquecer la consulta de retrieval.
    user-turns: 2
  cache:
    # Cachea embeddings/chunks para acelerar respuestas repetidas.
    enabled: true
  chunk:
    # TamaÃ±o y solapamiento de cada chunk de texto.
    size: 700
    overlap: 120
  rerank:
    # Numero de candidatos semÃ¡nticos previos al rerank con MMR.
    candidates: 10
    # Mezcla entre relevancia y diversidad (0-1).
    lambda: 0.70
  hybrid:
    # Peso de score semÃ¡ntico vs lexical en ranking final.
    semantic-weight: 0.85
    lexical-weight: 0.15
    # Bonus cuando la frase normalizada aparece de forma exacta.
    exact-match-boost: 0.10
  owner:
    # Asegura candidatos mÃ­nimos por owner (global/privado) antes de fusionar.
    min-candidates-per-owner: 8
    # PequeÃ±os boosts para que convivan mejor contextos globales y privados.
    global-boost: 0.03
    user-boost: 0.05
  score:
    # Puntaje minimo para aceptar un chunk en la busqueda inicial.
    min: 0.22

chat:
  queue:
    # Retraso en ms para suavizar picos de trÃ¡fico por sesiÃ³n.
    delay-ms: 15
  response-guard:
    # Segunda pasada para eliminar informacion innecesaria en la respuesta final.
    enabled: true
    # Evita costo extra en respuestas muy cortas.
    min-answer-chars: 320
    # Modo estricto: recorte mas agresivo de relleno.
    strict-mode: true


logging:
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} - %msg [rid=%X{requestId}]%n"
  level:
    org.springframework.security: DEBUG

monitoring:
  grafana-url: ${GRAFANA_URL:http://192.168.1.61:3000}
  prometheus-url: ${PROMETHEUS_URL:http://192.168.1.61:9090}
  internet-check-url: ${INTERNET_CHECK_URL:https://www.gstatic.com/generate_204}
  internet-check-timeout-ms: ${INTERNET_CHECK_TIMEOUT_MS:2000}
  alerts:
    enabled: ${MONITOR_ALERTS_ENABLED:true}
    check-interval-ms: ${MONITOR_ALERTS_INTERVAL_MS:15000}
    cooldown-ms: ${MONITOR_ALERTS_COOLDOWN_MS:300000}
    cpu-threshold: ${MONITOR_CPU_THRESHOLD:0.90}
    memory-threshold: ${MONITOR_MEM_THRESHOLD:0.90}
    disk-threshold: ${MONITOR_DISK_THRESHOLD:0.90}
    swap-threshold: ${MONITOR_SWAP_THRESHOLD:0.90}
    max-events: ${MONITOR_ALERTS_MAX_EVENTS:200}

management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  endpoint:
    health:
      show-details: when_authorized
  metrics:
    tags:
      application: apiasistente
  prometheus:
    metrics:
      export:
        enabled: true

registration:
  codes:
    default-ttl-minutes: ${REGISTRATION_CODE_TTL_MINUTES:1440}
    min-ttl-minutes: ${REGISTRATION_CODE_MIN_TTL_MINUTES:10}
    max-ttl-minutes: ${REGISTRATION_CODE_MAX_TTL_MINUTES:10080}
